#!/usr/bin/env bash

# Updated for PipeWire/Ubuntu 24.04
# Supports both Zenity (Legacy) and Rofi (Modern)

function list_sinks() {
  pactl list sinks | grep -E 'Sink #|Name:|Description:'
}

function switch_sink() {
  local target="$1"
  echo "Switching default to: $target"
  pactl set-default-sink "$target" || { echo "Failed to set default"; return 1; }

  echo "Moving existing application streams..."
  pactl list sink-inputs short | awk '{print $1}' | while read -r id; do
    pactl move-sink-input "$id" "$target"
  done
  
  # Optional: Send a desktop notification
  local desc=$(pactl list sinks | grep -A 20 "Name: $target" | grep "Description:" | cut -d: -f2- | xargs)
  notify-send "Audio Output Switched" "Active Device: $desc" -i audio-speakers
}

function switch_rofi() {
  # Get list of sinks: Name and Description
  # Format: "Description | Name"
  local options=$(pactl list sinks | awk -F': ' '
    /Name:/ {name=$2} 
    /Description:/ {print $2 " | " name}
  ')

  # Show rofi menu
  local selection=$(echo "$options" | rofi -dmenu -i -p "Select Audio Output" -l 10)

  if [ -n "$selection" ]; then
    # Extract the Name (everything after the last '|')
    local target_name=$(echo "$selection" | awk -F ' | ' '{print $NF}')
    switch_sink "$target_name"
  fi
}

function switch_zenity() {
  current_sink=$(pactl get-default-sink)
  mapfile -t sink_data < <(pactl list sinks | grep -E 'Name:|Description:' | sed 's/^[[:space:]]*//')
  zen_pars=("--list" "--radiolist" "--column" "Select" "--column" "Name" "--column" "Description")

  for ((i=0; i<${#sink_data[@]}; i+=2)); do
    name="${sink_data[$i]#Name: }"
    desc="${sink_data[$i+1]#Description: }"
    [[ "$name" == "$current_sink" ]] && zen_pars+=("TRUE" "$name" "$desc") || zen_pars+=("FALSE" "$name" "$desc")
  done

  new_sink=$(zenity "${zen_pars[@]}" --width=600 --height=300 --title="Select Audio Output" 2>/dev/null)
  [ -n "$new_sink" ] && switch_sink "$new_sink"
}

function help_me() {
  echo "Usage: $0 [rofi|gui|list|<sink name>]"
}

case "${1:-}" in
  ""|list) list_sinks        ;;
  rofi)    switch_rofi       ;;
  gui)     switch_zenity     ;;
  help)    help_me           ;;
  *)       switch_sink "$1"  ;;
esac
